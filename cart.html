<!-- public/cart.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Cart - Flipkart Clone</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="cart-page">
  <header class="navbar">
    <div class="logo">Flipkart Clone - Cart</div>
    <a href="products.html">← Back to Products</a>
    <span id="user-area"></span>
  </header>

  <main class="container">
    <h1>Your Cart</h1>
    <div id="cart-items"></div>

    <div id="cart-summary" class="cart-summary">
      <p>Total: ₹<span id="cart-total">0</span></p>
      <button id="btn-clear">Clear Cart</button>
      <button id="btn-checkout">Checkout</button>
    </div>

    <section id="orders-section" style="margin-top:20px;">
      <h2>Your Orders</h2>
      <div id="orders-list"></div>
    </section>
  </main>

  <script src="app.js"></script>
  <script>
    renderCart();

    document.getElementById('btn-clear').addEventListener('click', ()=> {
      localStorage.removeItem('cart');
      renderCart();
      updateCartCount();
    });

    document.getElementById('btn-checkout').addEventListener('click', async ()=>{
      const token = localStorage.getItem('token');
      if (!token) {
        alert('Please login to checkout.');
        window.location.href = 'index.html';
        return;
      }

      const cart = JSON.parse(localStorage.getItem('cart') || '[]');
      if (cart.length === 0) { alert('Cart is empty'); return; }
      const total = cart.reduce((s,i)=> s + i.price * i.qty, 0);

      try {
        const res = await fetch('/api/orders', {
          method: 'POST',
          headers: { 'Content-Type':'application/json', 'Authorization': 'Bearer ' + token },
          body: JSON.stringify({ items: cart, total })
        });
        const data = await res.json();
        if (res.ok) {
          alert('Order placed! Order ID: ' + data.id);
          localStorage.removeItem('cart');
          renderCart();
          updateCartCount();
          loadOrders();
        } else {
          alert(data.error || 'Failed to place order');
        }
      } catch(err) {
        alert('Error: ' + err.message);
      }
    });

    // load user orders
    async function loadOrders() {
      const token = localStorage.getItem('token');
      if (!token) { document.getElementById('orders-list').innerHTML = '<p>Login to see orders.</p>'; return; }
      try {
        const res = await fetch('/api/orders', { headers: { 'Authorization':'Bearer ' + token }});
        const orders = await res.json();
        const out = document.getElementById('orders-list');
        out.innerHTML = '';
        orders.forEach(o=>{
          const d = document.createElement('div');
          d.className = 'cart-item';
          d.innerHTML = `<div><strong>Order #${o.id}</strong><br/>Total: ₹${o.total}<br/>Placed: ${o.created_at || o.createdAt}</div>
            <div>${JSON.stringify(o.items)}</div>`;
          out.appendChild(d);
        });
      } catch(e) {
        console.error(e);
      }
    }

    loadOrders();
  </script>
</body>
</html>

